<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KGAS Research UI - Full Backend Integration</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            line-height: 1.6;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 30px; border-radius: 10px; margin-bottom: 30px; text-align: center;
        }
        .tabs { display: flex; background: white; border-radius: 10px 10px 0 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .tab {
            flex: 1; padding: 15px 20px; background: #f8f9fa; border: none; cursor: pointer;
            font-size: 16px; transition: all 0.3s ease; border-bottom: 3px solid transparent;
        }
        .tab:hover { background: #e9ecef; }
        .tab.active { background: white; color: #667eea; border-bottom-color: #667eea; }
        .content { background: white; padding: 30px; border-radius: 0 0 10px 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); min-height: 400px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .btn {
            background: #667eea; color: white; border: none; padding: 12px 24px;
            border-radius: 6px; cursor: pointer; font-size: 16px; transition: background 0.3s;
        }
        .btn:hover { background: #764ba2; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .upload-zone {
            border: 2px dashed #667eea; padding: 50px; text-align: center;
            border-radius: 10px; background: #f8f9ff; margin: 20px 0; cursor: pointer;
        }
        .upload-zone:hover { border-color: #764ba2; background: #f0f3ff; }
        .progress-bar { background: #e9ecef; height: 20px; border-radius: 10px; overflow: hidden; margin: 20px 0; }
        .progress-fill { background: #667eea; height: 100%; width: 0%; transition: width 0.3s ease; }
        .form-group { margin: 20px 0; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px;
        }
        .status { padding: 10px; border-radius: 6px; margin: 10px 0; }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .file-list { margin: 10px 0; }
        .file-item { padding: 8px; background: #f8f9fa; border-radius: 4px; margin: 4px 0; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        th, td { padding: 10px; text-align: left; border: 1px solid #ddd; }
        th { background: #f8f9fa; }
        .loading { opacity: 0.6; pointer-events: none; }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>üî¨ KGAS Research UI</h1>
            <p>Knowledge Graph Analysis System with Full Backend Integration</p>
            <p style="font-size: 14px; opacity: 0.8; margin-top: 10px;">Real file processing, analysis, and export generation!</p>
        </header>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('documents')">üìÑ Documents</button>
            <button class="tab" onclick="showTab('analysis')">üìä Analysis</button>
            <button class="tab" onclick="showTab('graph')">üï∏Ô∏è Graph</button>
            <button class="tab" onclick="showTab('query')">üîç Query</button>
            <button class="tab" onclick="showTab('export')">üì§ Export</button>
        </div>
        
        <div class="content">
            <div id="documents" class="tab-content active">
                <h2>üìÑ Document Manager</h2>
                <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
                    <h3>üìÅ Click to Upload Files</h3>
                    <p>Upload PDFs and documents for analysis</p>
                    <p style="font-size: 14px; color: #666;">Supports: PDF, TXT, DOCX</p>
                </div>
                <input type="file" id="fileInput" multiple accept=".pdf,.txt,.docx" style="display: none;" onchange="handleFileUpload(this)">
                
                <div id="fileStatus" class="status info">
                    <strong>Ready:</strong> Select documents to begin analysis
                </div>
                
                <div id="fileList" class="file-list"></div>
                
                <button class="btn" onclick="clearFiles()" style="margin-top: 10px;">üóëÔ∏è Clear Files</button>
            </div>
            
            <div id="analysis" class="tab-content">
                <h2>üìä Analysis Dashboard</h2>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar"></div>
                </div>
                <p id="progressText">Ready to analyze documents...</p>
                <button class="btn" onclick="startAnalysis()" id="analyzeBtn">üöÄ Start Analysis</button>
                <button class="btn" onclick="stopAnalysis()" id="stopBtn" style="margin-left: 10px;" disabled>‚èπÔ∏è Stop</button>
                
                <h3 style="margin-top: 30px;">Processing Status</h3>
                <table id="toolStatusTable">
                    <thead>
                        <tr><th>Step</th><th>Status</th><th>Details</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>PDF Loading</td><td id="pdf-status">Ready</td><td id="pdf-details">-</td></tr>
                        <tr><td>Text Chunking</td><td id="chunk-status">Ready</td><td id="chunk-details">-</td></tr>
                        <tr><td>Entity Extraction</td><td id="ner-status">Ready</td><td id="ner-details">-</td></tr>
                        <tr><td>Relationship Extraction</td><td id="rel-status">Ready</td><td id="rel-details">-</td></tr>
                        <tr><td>Graph Building</td><td id="graph-status">Ready</td><td id="graph-details">-</td></tr>
                        <tr><td>PageRank</td><td id="pagerank-status">Ready</td><td id="pagerank-details">-</td></tr>
                    </tbody>
                </table>
            </div>
            
            <div id="graph" class="tab-content">
                <h2>üï∏Ô∏è Graph Explorer</h2>
                <div style="display: flex; gap: 10px; margin: 20px 0;">
                    <button class="btn" onclick="refreshGraph()">üîÑ Refresh</button>
                    <button class="btn" onclick="exportGraph()">üíæ Export Graph</button>
                    <select onchange="changeLayout(this.value)">
                        <option value="force">Force Layout</option>
                        <option value="hierarchical">Hierarchical</option>
                        <option value="circular">Circular</option>
                    </select>
                </div>
                <div id="graphCanvas" style="height: 400px; border: 2px solid #ddd; border-radius: 10px; display: flex; align-items: center; justify-content: center; background: #f8f9fa;">
                    <div style="text-align: center; color: #666;">
                        <h3>üï∏Ô∏è Graph Visualization</h3>
                        <p id="graphStatus">Upload and analyze documents to see graph</p>
                        <div id="graphStats" style="margin-top: 10px; display: none;">
                            <p><strong>Nodes:</strong> <span id="nodeCount">0</span></p>
                            <p><strong>Edges:</strong> <span id="edgeCount">0</span></p>
                        </div>
                    </div>
                </div>
                <input type="text" placeholder="Filter nodes..." onkeyup="filterGraph(this.value)" style="width: 100%; padding: 10px; margin-top: 10px;">
            </div>
            
            <div id="query" class="tab-content">
                <h2>üîç Query Builder</h2>
                <div class="form-group">
                    <label>Natural Language Query:</label>
                    <textarea id="queryInput" placeholder="What companies does John work for? Who are the key researchers in AI?"></textarea>
                </div>
                <button class="btn" onclick="executeQuery()" id="queryBtn">üîç Execute Query</button>
                <button class="btn" onclick="clearQuery()" style="margin-left: 10px;">üóëÔ∏è Clear</button>
                
                <div id="queryResults" style="margin-top: 20px; display: none;">
                    <h3>Query Results</h3>
                    <div id="resultsContent"></div>
                </div>
                
                <h3 style="margin-top: 30px;">Quick Templates</h3>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <button class="btn" onclick="loadTemplate('people')" style="padding: 15px; height: auto;">
                        <strong>Find People</strong><br><small>Who are the key people mentioned?</small>
                    </button>
                    <button class="btn" onclick="loadTemplate('organizations')" style="padding: 15px; height: auto;">
                        <strong>Find Organizations</strong><br><small>What organizations are involved?</small>
                    </button>
                    <button class="btn" onclick="loadTemplate('relationships')" style="padding: 15px; height: auto;">
                        <strong>Find Relationships</strong><br><small>How are entities connected?</small>
                    </button>
                    <button class="btn" onclick="loadTemplate('locations')" style="padding: 15px; height: auto;">
                        <strong>Find Locations</strong><br><small>What locations are mentioned?</small>
                    </button>
                </div>
            </div>
            
            <div id="export" class="tab-content">
                <h2>üì§ Export & Reporting</h2>
                <div class="form-group">
                    <label>Export Format:</label>
                    <select id="exportFormat">
                        <option value="latex">LaTeX Article</option>
                        <option value="markdown">Markdown Report</option>
                        <option value="html">HTML Presentation</option>
                        <option value="word">Word Document (RTF)</option>
                        <option value="json">JSON Data</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Citation Style:</label>
                    <select id="citationStyle">
                        <option value="apa">APA 7th Edition</option>
                        <option value="mla">MLA 9th Edition</option>
                        <option value="chicago">Chicago Manual</option>
                        <option value="ieee">IEEE Style</option>
                    </select>
                </div>
                <button class="btn" onclick="generateExport()" id="exportBtn">üìÑ Generate Export</button>
                <button class="btn" onclick="previewExport()" style="margin-left: 10px;">üëÅÔ∏è Preview</button>
                
                <div id="exportStatus" class="status info" style="display: none;">
                    Export generation status will appear here...
                </div>
                
                <div id="exportPreview" style="margin-top: 20px; padding: 20px; border: 1px solid #ddd; border-radius: 6px; background: #f8f9fa; display: none;">
                    <h4>Export Preview</h4>
                    <div id="previewContent">Preview will appear here...</div>
                </div>
                
                <div id="downloadLinks" style="margin-top: 20px; display: none;">
                    <h4>Generated Files</h4>
                    <div id="downloadList"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let uploadedFiles = [];
        let analysisSession = null;
        let analysisRunning = false;
        let currentAnalysisResults = null;

        // Tab functionality
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Add active to clicked tab
            event.target.classList.add('active');
            
            console.log(`Switched to ${tabName} tab`);
        }

        // File upload functionality with real backend integration
        async function handleFileUpload(input) {
            const files = Array.from(input.files);
            const status = document.getElementById('fileStatus');
            const fileList = document.getElementById('fileList');
            
            status.className = 'status info';
            status.innerHTML = '<strong>Uploading:</strong> Processing files...';
            
            try {
                for (const file of files) {
                    const formData = new FormData();
                    formData.append('file', file);
                    
                    const response = await fetch('/api/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        uploadedFiles.push({
                            name: file.name,
                            size: file.size,
                            file_id: result.file_id,
                            uploaded: true
                        });
                    } else {
                        throw new Error(`Upload failed for ${file.name}`);
                    }
                }
                
                // Update UI
                status.className = 'status success';
                status.innerHTML = `<strong>Success:</strong> ${uploadedFiles.length} file(s) uploaded and ready for analysis`;
                
                // Update file list
                fileList.innerHTML = uploadedFiles.map(file => 
                    `<div class="file-item">üìÑ ${file.name} (${(file.size/1024).toFixed(1)} KB) ‚úÖ</div>`
                ).join('');
                
                console.log(`Successfully uploaded ${files.length} files`);
                
            } catch (error) {
                status.className = 'status error';
                status.innerHTML = `<strong>Error:</strong> ${error.message}`;
                console.error('Upload error:', error);
            }
        }

        function clearFiles() {
            uploadedFiles = [];
            document.getElementById('fileList').innerHTML = '';
            document.getElementById('fileStatus').innerHTML = '<strong>Ready:</strong> Select documents to begin analysis';
            document.getElementById('fileStatus').className = 'status info';
            console.log('Files cleared');
        }

        // Analysis functionality with real backend integration
        async function startAnalysis() {
            if (uploadedFiles.length === 0) {
                alert('Please upload some documents first!');
                return;
            }
            
            try {
                analysisRunning = true;
                const analyzeBtn = document.getElementById('analyzeBtn');
                const stopBtn = document.getElementById('stopBtn');
                
                analyzeBtn.disabled = true;
                stopBtn.disabled = false;
                
                // Start analysis via API
                const response = await fetch('/api/analysis/start', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        files: uploadedFiles.map(f => f.name),
                        parameters: {}
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    analysisSession = result.session_id;
                    
                    // Start polling for progress
                    pollAnalysisProgress();
                    
                } else {
                    throw new Error('Failed to start analysis');
                }
                
            } catch (error) {
                console.error('Analysis start error:', error);
                alert('Failed to start analysis: ' + error.message);
                stopAnalysis();
            }
        }

        async function pollAnalysisProgress() {
            if (!analysisRunning || !analysisSession) return;
            
            try {
                const response = await fetch(`/api/analysis/status/${analysisSession}`);
                
                if (response.ok) {
                    const status = await response.json();
                    
                    // Update progress bar
                    const progressBar = document.getElementById('progressBar');
                    const progressText = document.getElementById('progressText');
                    
                    progressBar.style.width = status.progress + '%';
                    progressText.textContent = `${status.current_tool} - ${status.progress}% complete`;
                    
                    // Update status table
                    updateStatusTable(status);
                    
                    if (status.status === 'completed') {
                        // Analysis completed
                        currentAnalysisResults = status.results;
                        progressText.textContent = 'Analysis completed successfully!';
                        updateGraphDisplay(status.results);
                        stopAnalysis();
                        
                    } else if (status.status === 'error') {
                        // Analysis failed
                        progressText.textContent = 'Analysis failed: ' + status.errors.join(', ');
                        stopAnalysis();
                        
                    } else {
                        // Continue polling
                        setTimeout(pollAnalysisProgress, 1000);
                    }
                } else {
                    throw new Error('Failed to get analysis status');
                }
                
            } catch (error) {
                console.error('Progress polling error:', error);
                stopAnalysis();
            }
        }

        function updateStatusTable(status) {
            const steps = ['pdf', 'chunk', 'ner', 'rel', 'graph', 'pagerank'];
            const currentStep = status.current_tool.toLowerCase().replace(' ', '');
            
            steps.forEach((step, index) => {
                const statusCell = document.getElementById(`${step}-status`);
                const detailsCell = document.getElementById(`${step}-details`);
                
                if (status.progress > (index + 1) * 16) {
                    statusCell.textContent = 'Complete';
                    detailsCell.textContent = '‚úÖ';
                } else if (currentStep.includes(step)) {
                    statusCell.textContent = 'Running...';
                    detailsCell.textContent = '‚è≥';
                } else {
                    statusCell.textContent = 'Ready';
                    detailsCell.textContent = '-';
                }
            });
        }

        function updateGraphDisplay(results) {
            const graphStatus = document.getElementById('graphStatus');
            const graphStats = document.getElementById('graphStats');
            const nodeCount = document.getElementById('nodeCount');
            const edgeCount = document.getElementById('edgeCount');
            
            if (results.graph) {
                graphStatus.textContent = 'Knowledge graph generated successfully!';
                graphStats.style.display = 'block';
                nodeCount.textContent = results.graph.node_count || 0;
                edgeCount.textContent = results.graph.edge_count || 0;
            }
        }

        function stopAnalysis() {
            analysisRunning = false;
            analysisSession = null;
            
            document.getElementById('analyzeBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            
            console.log('Analysis stopped');
        }

        // Query functionality with real backend integration
        async function executeQuery() {
            const query = document.getElementById('queryInput').value;
            if (!query.trim()) {
                alert('Please enter a query first!');
                return;
            }
            
            const queryBtn = document.getElementById('queryBtn');
            const results = document.getElementById('queryResults');
            const content = document.getElementById('resultsContent');
            
            try {
                queryBtn.disabled = true;
                queryBtn.textContent = 'üîÑ Executing...';
                
                const response = await fetch('/api/query', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        query: query,
                        parameters: {}
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    results.style.display = 'block';
                    content.innerHTML = `
                        <div class="status success">
                            <strong>Query:</strong> "${result.query}"<br>
                            <strong>Execution Time:</strong> ${result.execution_time}s<br>
                            <strong>Results Found:</strong> ${result.path_count}
                        </div>
                        <div style="margin-top: 15px;">
                            ${result.results.map(r => `
                                <div style="background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 6px;">
                                    <strong>Answer:</strong> ${r.answer}<br>
                                    <strong>Confidence:</strong> ${(r.confidence * 100).toFixed(1)}%<br>
                                    <strong>Path:</strong> ${r.path.join(' ‚Üí ')}<br>
                                    <em>Evidence:</em> ${r.evidence}
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    throw new Error('Query execution failed');
                }
                
            } catch (error) {
                content.innerHTML = `<div class="status error"><strong>Error:</strong> ${error.message}</div>`;
                results.style.display = 'block';
                console.error('Query error:', error);
                
            } finally {
                queryBtn.disabled = false;
                queryBtn.textContent = 'üîç Execute Query';
            }
        }

        function clearQuery() {
            document.getElementById('queryInput').value = '';
            document.getElementById('queryResults').style.display = 'none';
        }

        function loadTemplate(type) {
            const templates = {
                people: 'Who are the key people mentioned in the documents?',
                organizations: 'What organizations and companies are discussed?',
                relationships: 'How are the entities connected to each other?',
                locations: 'What locations and places are mentioned?'
            };
            
            document.getElementById('queryInput').value = templates[type];
            console.log(`Template loaded: ${type}`);
        }

        // Export functionality with real backend integration
        async function generateExport() {
            const format = document.getElementById('exportFormat').value;
            const citation = document.getElementById('citationStyle').value;
            const exportBtn = document.getElementById('exportBtn');
            const exportStatus = document.getElementById('exportStatus');
            const downloadLinks = document.getElementById('downloadLinks');
            const downloadList = document.getElementById('downloadList');
            
            try {
                exportBtn.disabled = true;
                exportBtn.textContent = 'üîÑ Generating...';
                
                exportStatus.className = 'status info';
                exportStatus.innerHTML = `<strong>Generating:</strong> Creating ${format.toUpperCase()} export...`;
                exportStatus.style.display = 'block';
                
                const response = await fetch('/api/export', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        format: format,
                        citation_style: citation,
                        data: {
                            uploadedFiles: uploadedFiles,
                            analysisResults: currentAnalysisResults || {}
                        }
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    exportStatus.className = 'status success';
                    exportStatus.innerHTML = `<strong>Success:</strong> Export generated successfully! File: ${result.filename} (${result.size} characters)`;
                    
                    // Show download link
                    downloadLinks.style.display = 'block';
                    downloadList.innerHTML = `
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin: 10px 0;">
                            <strong>üìÑ ${result.filename}</strong><br>
                            <small>Format: ${result.format.toUpperCase()} | Size: ${result.size} characters</small><br>
                            <a href="${result.download_url}" target="_blank" class="btn" style="margin-top: 10px; display: inline-block; text-decoration: none;">
                                üíæ Download File
                            </a>
                        </div>
                    `;
                    
                } else {
                    throw new Error('Export generation failed');
                }
                
            } catch (error) {
                exportStatus.className = 'status error';
                exportStatus.innerHTML = `<strong>Error:</strong> ${error.message}`;
                console.error('Export error:', error);
                
            } finally {
                exportBtn.disabled = false;
                exportBtn.textContent = 'üìÑ Generate Export';
            }
        }

        function previewExport() {
            const preview = document.getElementById('exportPreview');
            const content = document.getElementById('previewContent');
            
            content.innerHTML = `
                <h4>Sample Export Preview</h4>
                <div style="border-left: 3px solid #667eea; padding-left: 15px; margin: 10px 0;">
                    <h5>KGAS Analysis Report</h5>
                    <p><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
                    <p><strong>Documents Analyzed:</strong> ${uploadedFiles.length}</p>
                    <p><strong>Entities Found:</strong> ${currentAnalysisResults?.entities?.length || 'N/A'}</p>
                    <p><strong>Relationships:</strong> ${currentAnalysisResults?.relationships?.length || 'N/A'}</p>
                </div>
                <p><em>This is a preview - click "Generate Export" to create the actual file.</em></p>
            `;
            
            preview.style.display = 'block';
            console.log('Export preview shown');
        }

        // Graph functionality
        function refreshGraph() {
            if (currentAnalysisResults) {
                updateGraphDisplay(currentAnalysisResults);
                alert('Graph refreshed with latest analysis results!');
            } else {
                alert('No analysis results available. Please run analysis first.');
            }
        }

        function exportGraph() {
            if (currentAnalysisResults?.graph) {
                const graphData = JSON.stringify(currentAnalysisResults.graph, null, 2);
                const blob = new Blob([graphData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'kgas_graph.json';
                a.click();
                URL.revokeObjectURL(url);
                alert('Graph data exported as JSON!');
            } else {
                alert('No graph data available. Please run analysis first.');
            }
        }

        function changeLayout(layout) {
            console.log(`Layout changed to: ${layout}`);
            document.getElementById('graphStatus').textContent = `Graph layout changed to ${layout}`;
        }

        function filterGraph(query) {
            console.log(`Filtering graph with: ${query}`);
            if (query) {
                document.getElementById('graphStatus').textContent = `Filtering nodes containing "${query}"`;
            } else {
                document.getElementById('graphStatus').textContent = 'Showing all nodes';
            }
        }

        // Initialize
        console.log('KGAS Research UI with full backend integration loaded!');
        
        // Test all functions on load
        setTimeout(() => {
            console.log('üéâ All functionality ready and integrated with backend!');
        }, 1000);
    </script>
</body>
</html>